{"version":3,"sources":["../src/videoHelp.ts"],"names":[],"mappings":"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","file":"videoHelp.js","sourceRoot":"","sourcesContent":["import { EventEmitter } from \"@angular/core\"\r\n\r\nexport const browser = <any>navigator\r\nexport function getMedia(){\r\n  return browser.getUserMedia\r\n  || browser.webkitGetUserMedia\r\n  || browser.mozGetUserMedia\r\n  || browser.msGetUserMedia\r\n}\r\n\r\n/**\r\n * Component options structure interface\r\n */\r\nexport interface Options {\r\n  video: boolean | any\r\n  audio: boolean\r\n  width: number\r\n  height: number\r\n  fallback:boolean\r\n  fallbackSrc: string\r\n  fallbackMode: string\r\n  fallbackQuality: number\r\n}\r\n\r\nexport interface VideoObject{\r\n  capture:Function,\r\n  save:Function,\r\n  appendChild:Function\r\n  classid?:string,\r\n  data?:{}\r\n}\r\n\r\nexport interface Canvas{\r\n  toDataURL:Function,\r\n  getContext:Function,\r\n  width,\r\n  height\r\n}\r\n\r\n/*\r\nexport interface MediaDevice{\r\n  deviceId: string\r\n  kind: \"videoinput\" | \"audioinput\" | string\r\n  label: string\r\n  groupId: string\r\n}*/\r\n\r\n\r\nexport function dataUriToBlob(dataURI) {\r\n  // convert base64/URLEncoded data component to raw binary data held in a string\r\n  var byteString;\r\n  if (dataURI.split(',')[0].indexOf('base64') >= 0){\r\n    byteString = atob(dataURI.split(',')[1]);\r\n  }else{\r\n    byteString = window['unescape'](dataURI.split(',')[1]);\r\n  }\r\n\r\n  // separate out the mime component\r\n  var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];\r\n  // write the bytes of the string to a typed array\r\n  var ia = new Uint8Array(byteString.length);\r\n  for (var i = 0; i < byteString.length; i++) {\r\n      ia[i] = byteString.charCodeAt(i);\r\n  }\r\n\r\n  return new Blob([ia], {type:mimeString});\r\n}\r\n\r\n/** single image to transmittable resource */\r\nexport function dataUriToFormData(\r\n  dataURI,\r\n  options?:{fileName?:string, form?:FormData}\r\n){\r\n  options = options || {}\r\n  options.form = options.form || new FormData()\r\n  options.form.append('file', dataUriToBlob(dataURI), options.fileName||'file.jpg');\r\n  return options.form\r\n}\r\n\r\nexport function drawImageArrayToCanvas( imgArray:string[] ):Canvas{\r\n  const canvas = document.createElement('canvas')\r\n\r\n  // const di = this.getVideoDimensions()\r\n  const ctx = canvas.getContext('2d');\r\n  const width = imgArray[0].split(';').length\r\n  const height = imgArray.length\r\n  canvas.width = width\r\n  canvas.height = height\r\n  ctx.clearRect(0, 0, width, height);\r\n\r\n  const externData = {\r\n    imgData: ctx.getImageData(0, 0, width, height),\r\n    pos: 0\r\n  };\r\n\r\n  let tmp = null;\r\n  for(let x=0; x < imgArray.length; ++x){\r\n    let col = imgArray[x].split(';')\r\n    for (let i = 0; i < width; i++) {\r\n      tmp = parseInt(col[i], 10);\r\n      externData.imgData.data[externData.pos + 0] = (tmp >> 16) & 0xff;\r\n      externData.imgData.data[externData.pos + 1] = (tmp >> 8) & 0xff;\r\n      externData.imgData.data[externData.pos + 2] = tmp & 0xff;\r\n      externData.imgData.data[externData.pos + 3] = 0xff;\r\n      externData.pos += 4;\r\n    }\r\n\r\n    /*if (externData.pos >= 4 * width * height) {\r\n      ctx.putImageData(externData.imgData, 0, 0);\r\n      externData.pos = 0;\r\n    }*/\r\n  }\r\n\r\n  ctx.putImageData(externData.imgData, 0, 0);\r\n\r\n  return canvas\r\n}\r\n\r\nexport class Fallback{\r\n  debug:Function\r\n  onCapture:Function\r\n  onSave:Function\r\n  videoObject:VideoObject\r\n  onImage = new EventEmitter()\r\n  \r\n  constructor(videoObject:VideoObject){\r\n    this.videoObject = videoObject\r\n    const dataImgArray = []\r\n\r\n    //method intended to live within window memory\r\n    this.debug = (tag, message)=>{\r\n      if(tag=='notify' && message=='Capturing finished.'){\r\n        this.onImage.emit( drawImageArrayToCanvas(dataImgArray) )\r\n      }\r\n    }\r\n\r\n    //method intended to live within window memory\r\n    this.onCapture = ()=>{\r\n      dataImgArray.length = 0\r\n      videoObject.save()\r\n    }\r\n\r\n    //method intended to live within window memory\r\n    this.onSave = (data) => {\r\n      dataImgArray.push(data)\r\n    }\r\n\r\n    //Flash swf file expects window.webcam to exist as communication bridge\r\n    window['webcam'] = this\r\n  }\r\n\r\n\r\n  captureToCanvas():Promise<Canvas>{\r\n    console.log('333', this.videoObject)\r\n    return new Promise((res,rej)=>{\r\n      const subscription = this.onImage.subscribe(img=>{\r\n        res(img)\r\n        subscription.unsubscribe()\r\n      })\r\n      this.videoObject.capture()\r\n    })\r\n  }\r\n\r\n  captureBase64(mime?):Promise<string>{\r\n    return this.captureToCanvas()\r\n    .then( (canvas:Canvas)=>canvas.toDataURL(mime || 'image/jpeg') )\r\n  }\r\n\r\n  /**\r\n   * Add <param>'s into fallback object\r\n   * @param cam - Flash web camera instance\r\n   * @returns {void}\r\n   */\r\n  addFallbackParams(options:Options): any {\r\n    const paramFlashVars = document.createElement('param');\r\n    paramFlashVars.name = 'FlashVars';\r\n    paramFlashVars.value = 'mode=' + options.fallbackMode + '&amp;quality=' + options.fallbackQuality;\r\n    this.videoObject.appendChild(paramFlashVars);\r\n\r\n    const paramAllowScriptAccess = document.createElement('param');\r\n    paramAllowScriptAccess.name = 'allowScriptAccess';\r\n    paramAllowScriptAccess.value = 'always';\r\n    this.videoObject.appendChild(paramAllowScriptAccess);\r\n\r\n    //is this even needed?\r\n    this.videoObject.classid = 'clsid:D27CDB6E-AE6D-11cf-96B8-444553540000';\r\n    \r\n    const paramMovie = document.createElement('param');\r\n    paramMovie.name = 'movie';\r\n    paramMovie.value = options.fallbackSrc;\r\n    this.videoObject.appendChild(paramMovie);\r\n    this.videoObject.data = options.fallbackSrc;\r\n  }\r\n}\r\n\r\nexport function videoInputsByDevices(devices:MediaDeviceInfo[]):MediaDeviceInfo[]{\r\n  return devicesByKind(devices,'videoinput')\r\n}\r\n\r\nexport function audioInputsByDevices(devices:MediaDeviceInfo[]):MediaDeviceInfo[]{\r\n  return devicesByKind(devices,'audioinput')\r\n}\r\n\r\nexport function audioOutputsByDevices(devices:MediaDeviceInfo[]):MediaDeviceInfo[]{\r\n  return devicesByKind(devices,'audiooutput')\r\n}\r\n\r\nexport function devicesByKind(devices:MediaDeviceInfo[], kind:string):MediaDeviceInfo[]{\r\n  return devices.filter(device=>device.kind===kind)\r\n}\r\n\r\nexport function promiseDeviceById(id:string):Promise<MediaDeviceInfo> {\r\n  return promiseDevices().then( devices=>devices.find(device=>device.deviceId==id) )\r\n}\r\n\r\nexport function promiseDevices():Promise<MediaDeviceInfo[]> {\r\n  //const x:Promise<MediaDeviceInfo[]> = browser.mediaDevices.enumerateDevices().then( devices=>devices )\r\n  return browser.mediaDevices.enumerateDevices()\r\n}\r\n\r\nexport function isFacingModeSupported():boolean{\r\n  if(!browser.mediaDevices)return false\r\n  const contraints = browser.mediaDevices.getSupportedConstraints()\r\n  return contraints.facingMode\r\n}\r\n"]}